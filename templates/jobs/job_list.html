{% extends 'base.html' %}

{% block title %}æµè§ˆå…¼èŒ - æ ¡å›­å…¼èŒå¹³å°{% endblock %}

{% block content %}
<div style="background-color: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h1 style="color: #667eea; margin: 0;">æµè§ˆå…¼èŒ</h1>
            <p style="color: #999; margin-top: 0.5rem;">å…±æ‰¾åˆ° {{ total_count }} ä¸ªå…¼èŒ</p>
        </div>
        {% if user.is_authenticated %}
            <a href="{% url 'jobs:job_create' %}" class="btn btn-primary">å‘å¸ƒå…¼èŒ</a>
        {% endif %}
    </div>

    <!-- æœç´¢å’Œå¿«é€Ÿç­›é€‰ -->
    <form method="get" id="filterForm">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <input type="text" name="search" placeholder="ğŸ” æœç´¢æ ‡é¢˜ã€æè¿°ã€åœ°ç‚¹..." value="{{ search_query }}"
                   style="flex: 1; min-width: 250px; padding: 0.8rem 1rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">

            <select name="category" style="padding: 0.8rem 1rem; border: 2px solid #e0e0e0; border-radius: 10px; min-width: 150px;">
                <option value="">æ‰€æœ‰åˆ†ç±»</option>
                {% for value, label in categories %}
                    <option value="{{ value }}" {% if category == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <button type="submit" class="btn btn-primary">æœç´¢</button>
            <a href="{% url 'jobs:job_list' %}" class="btn btn-secondary">é‡ç½®</a>
        </div>

        <!-- é«˜çº§ç­›é€‰é¢æ¿ -->
        <div class="filter-panel" id="advancedFilter">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #667eea;">
                <h3 style="color: #667eea; margin: 0;">é«˜çº§ç­›é€‰</h3>
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleFilter()">
                    <span id="filterToggleText">æ”¶èµ·</span> â–²
                </button>
            </div>

            <div id="filterContent">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- è–ªèµ„èŒƒå›´ -->
                    <div>
                        <label style="display: block; font-weight: 600; color: #666; margin-bottom: 0.5rem;">ğŸ’° è–ªèµ„èŒƒå›´</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" name="min_salary" placeholder="æœ€ä½" value="{{ min_salary }}"
                                   style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 8px;"
                                   step="0.01" min="0">
                            <span>-</span>
                            <input type="number" name="max_salary" placeholder="æœ€é«˜" value="{{ max_salary }}"
                                   style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 8px;"
                                   step="0.01" min="0">
                        </div>
                    </div>

                    <!-- è–ªèµ„ç±»å‹ -->
                    <div>
                        <label style="display: block; font-weight: 600; color: #666; margin-bottom: 0.5rem;">ğŸ’µ è–ªèµ„ç±»å‹</label>
                        <select name="salary_type" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="">å…¨éƒ¨</option>
                            {% for value, label in salary_types %}
                                <option value="{{ value }}" {% if salary_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- åœ°ç‚¹ç­›é€‰ -->
                    <div>
                        <label style="display: block; font-weight: 600; color: #666; margin-bottom: 0.5rem;">ğŸ“ å·¥ä½œåœ°ç‚¹</label>
                        <input type="text" name="location" placeholder="è¾“å…¥åœ°ç‚¹å…³é”®è¯" value="{{ location_filter }}"
                               style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 8px;">
                    </div>

                    <!-- æ’åºæ–¹å¼ -->
                    <div>
                        <label style="display: block; font-weight: 600; color: #666; margin-bottom: 0.5rem;">ğŸ”„ æ’åºæ–¹å¼</label>
                        <select name="order_by" style="width: 100%; padding: 0.6rem; border: 1px solid #ddd; border-radius: 8px;">
                            <option value="newest" {% if order_by == 'newest' %}selected{% endif %}>æœ€æ–°å‘å¸ƒ</option>
                            <option value="oldest" {% if order_by == 'oldest' %}selected{% endif %}>æœ€æ—©å‘å¸ƒ</option>
                            <option value="salary_high" {% if order_by == 'salary_high' %}selected{% endif %}>è–ªèµ„ä»é«˜åˆ°ä½</option>
                            <option value="salary_low" {% if order_by == 'salary_low' %}selected{% endif %}>è–ªèµ„ä»ä½åˆ°é«˜</option>
                            <option value="positions_high" {% if order_by == 'positions_high' %}selected{% endif %}>æ‹›è˜äººæ•°å¤š</option>
                            <option value="positions_low" {% if order_by == 'positions_low' %}selected{% endif %}>æ‹›è˜äººæ•°å°‘</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">åº”ç”¨ç­›é€‰</button>
                    <a href="{% url 'jobs:job_list' %}" class="btn btn-secondary" style="flex: 1; text-align: center; line-height: 2.5;">æ¸…ç©ºç­›é€‰</a>
                </div>
            </div>
        </div>
    </form>

    <!-- å½“å‰ç­›é€‰æ ‡ç­¾ -->
    {% if search_query or category or salary_type or min_salary or max_salary or location_filter %}
    <div style="margin-top: 1.5rem; margin-bottom: 1rem;">
        <span style="color: #666; margin-right: 0.5rem;">å½“å‰ç­›é€‰ï¼š</span>
        {% if search_query %}
            <span class="filter-tag">å…³é”®è¯: {{ search_query }}</span>
        {% endif %}
        {% if category %}
            <span class="filter-tag">åˆ†ç±»: {{ category|default:"å…¨éƒ¨" }}</span>
        {% endif %}
        {% if salary_type %}
            <span class="filter-tag">è–ªèµ„ç±»å‹: {{ salary_type }}</span>
        {% endif %}
        {% if min_salary %}
            <span class="filter-tag">æœ€ä½è–ªèµ„: {{ min_salary }}å…ƒ</span>
        {% endif %}
        {% if max_salary %}
            <span class="filter-tag">æœ€é«˜è–ªèµ„: {{ max_salary }}å…ƒ</span>
        {% endif %}
        {% if location_filter %}
            <span class="filter-tag">åœ°ç‚¹: {{ location_filter }}</span>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- å…¼èŒåˆ—è¡¨ -->
{% if jobs %}
    <div style="display: grid; gap: 1.5rem;">
        {% for job in jobs %}
            <div class="job-card">
                <div class="job-header">
                    <h2 class="job-title">
                        <a href="{% url 'jobs:job_detail' job.pk %}">{{ job.title }}</a>
                    </h2>
                    <span class="job-category">{{ job.get_category_display }}</span>
                </div>

                <div class="job-info">
                    <div class="job-salary">
                        <strong>ğŸ’° {{ job.salary }} å…ƒ</strong>
                        <span>({{ job.get_salary_type_display }})</span>
                    </div>
                    <div class="job-meta">
                        <span>ğŸ“ {{ job.location }}</span>
                        <span>â° {{ job.duration }}</span>
                        <span>ğŸ‘¥ æ‹›{{ job.positions }}äºº</span>
                    </div>
                </div>

                <p class="job-desc">{{ job.description|truncatewords:30 }}</p>

                <div class="job-footer">
                    <div>
                        <span>å‘å¸ƒè€…ï¼š{{ job.publisher.username }}</span>
                        <span style="margin-left: 1rem;">{{ job.created_at|date:"Y-m-d H:i" }}</span>
                    </div>
                    <a href="{% url 'jobs:job_detail' job.pk %}" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div style="background-color: white; padding: 3rem; border-radius: 15px; text-align: center; color: #999;">
        <p style="font-size: 1.2rem;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å…¼èŒ</p>
        <a href="{% url 'jobs:job_list' %}" class="btn btn-secondary" style="margin-top: 1rem;">æŸ¥çœ‹æ‰€æœ‰å…¼èŒ</a>
        {% if user.is_authenticated %}
            <a href="{% url 'jobs:job_create' %}" class="btn btn-primary" style="margin-top: 1rem;">å‘å¸ƒå…¼èŒ</a>
        {% endif %}
    </div>
{% endif %}

<script>
function toggleFilter() {
    const content = document.getElementById('filterContent');
    const text = document.getElementById('filterToggleText');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        text.textContent = 'æ”¶èµ·';
    } else {
        content.style.display = 'none';
        text.textContent = 'å±•å¼€';
    }
}

// åˆå§‹åŒ–æ—¶å±•å¼€ç­›é€‰é¢æ¿
document.addEventListener('DOMContentLoaded', function() {
    const hasFilters = {{ search_query|yesno:"true,false" }} ||
                      {{ category|yesno:"true,false" }} ||
                      {{ salary_type|yesno:"true,false" }} ||
                      {{ min_salary|yesno:"true,false" }} ||
                      {{ max_salary|yesno:"true,false" }} ||
                      {{ location_filter|yesno:"true,false" }};
    if (!hasFilters) {
        // é»˜è®¤æ”¶èµ·é«˜çº§ç­›é€‰
        document.getElementById('filterContent').style.display = 'none';
        document.getElementById('filterToggleText').textContent = 'å±•å¼€';
    }
});
</script>
{% endblock %}
